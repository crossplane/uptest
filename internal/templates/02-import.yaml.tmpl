# This file belongs to the resource import step.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: import
spec:
  timeouts:
    apply: {{ .TestCase.Timeout }}
    assert: {{ .TestCase.Timeout }}
    exec: {{ .TestCase.Timeout }}
  steps:
  - name: Remove State
    description: |
      Removes the resource statuses from MRs and controllers. For controllers
      the scale down&up was applied. For MRs status conditions are patched.
      Also, for the assertion step, the ID before import was stored in the
      uptest-old-id annotation.
    try:
    - script:
        content: |
          {{- range $resource := .Resources }}
          {{- if eq $resource.KindGroup "secret." -}}
            {{continue}}
          {{- end }}
          ${KUBECTL} annotate {{ if $resource.Namespace }}--namespace {{ $resource.Namespace }} {{ end }} {{ $resource.KindGroup }}/{{ $resource.Name }} crossplane.io/paused=true --overwrite
          {{- end }}
          PROVIDER_CONFIGS=$(${KUBECTL} get deploymentruntimeconfig --no-headers -o custom-columns=":metadata.name" | grep "provider-" || true)
          if [ -n "$PROVIDER_CONFIGS" ]; then
            echo "$PROVIDER_CONFIGS" | xargs ${KUBECTL} patch deploymentruntimeconfig --type='json' -p='[{"op": "replace", "path": "/spec/deploymentTemplate/spec/replicas", "value": 0}]'
          else
            echo "No provider DeploymentRuntimeConfigs found to scale down"
          fi
    - sleep:
        duration: 10s
    - script:
        content: |
          PROVIDER_CONFIGS=$(${KUBECTL} get deploymentruntimeconfig --no-headers -o custom-columns=":metadata.name" | grep "provider-" || true)
          if [ -n "$PROVIDER_CONFIGS" ]; then
            echo "$PROVIDER_CONFIGS" | xargs ${KUBECTL} patch deploymentruntimeconfig --type='json' -p='[{"op": "replace", "path": "/spec/deploymentTemplate/spec/replicas", "value": 1}]'
          else
            echo "No provider DeploymentRuntimeConfigs found to scale up"
          fi
          curl -sL https://raw.githubusercontent.com/crossplane/uptest/main/hack/check_endpoints.sh -o /tmp/check_endpoints.sh && chmod +x /tmp/check_endpoints.sh
          curl -sL https://raw.githubusercontent.com/crossplane/uptest/main/hack/patch.sh -o /tmp/patch.sh && chmod +x /tmp/patch.sh
          curl -sL https://raw.githubusercontent.com/crossplane/uptest/main/hack/patch-ns.sh -o /tmp/patch-ns.sh && chmod +x /tmp/patch-ns.sh
          /tmp/check_endpoints.sh
          sleep 10
    {{- range $resource := .Resources }}
    {{- if eq $resource.KindGroup "secret." -}}
      {{continue}}
    {{- end -}}
    {{- if not $resource.SkipImport }}
    {{- if not $resource.Namespace }}
          /tmp/patch.sh {{ $resource.KindGroup }} {{ $resource.Name }}
    {{- end }}
    {{- if $resource.Namespace }}
          /tmp/patch-ns.sh {{ $resource.KindGroup }} {{ $resource.Name }} {{ $resource.Namespace }}
    {{- end }}
    {{- end }}
    {{- end }}
          {{- range $resource := .Resources }}
          {{- if eq $resource.KindGroup "secret." -}}
            {{continue}}
          {{- end }}
          ${KUBECTL} annotate {{ if $resource.Namespace }}--namespace {{ $resource.Namespace }} {{ end }} {{ $resource.KindGroup }}/{{ $resource.Name }} --all crossplane.io/paused=false --overwrite
          {{- end }}
  - name: Assert Status Conditions and IDs
    description: |
      Assert imported resources. Firstly check the status conditions. Then
      compare the stored ID and the new populated ID. For successful test,
      the ID must be the same.
    try:
    {{- range $resource := .Resources }}
    {{- if eq $resource.KindGroup "secret." -}}
      {{continue}}
    {{- end }}
    {{- if not $resource.SkipImport }}
    - assert:
        resource:
          apiVersion: {{ $resource.APIVersion }}
          kind: {{ $resource.Kind }}
          metadata:
            name: {{ $resource.Name }}
            {{- if $resource.Namespace }}
            namespace: {{ $resource.Namespace }}
            {{- end }}
          status:
            {{- range $condition := $resource.Conditions }}
            ((conditions[?type == '{{ $condition }}'])[0]):
              status: "True"
            {{- end }}
    {{- end }}
    {{- if not $resource.SkipImport }}
    - assert:
        timeout: 1m
        resource:
          apiVersion: {{ $resource.APIVersion }}
          kind: {{ $resource.Kind }}
          metadata:
            name: {{ $resource.Name }}
            {{- if $resource.Namespace }}
            namespace: {{ $resource.Namespace }}
            {{- end }}
          ("status.atProvider.id" == "metadata.annotations.uptest-old-id"): true
    {{- end }}
    {{- end }}
