# This file belongs to the resource update step.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: update
spec:
  timeouts:
    apply: {{ .TestCase.Timeout }}
    assert: {{ .TestCase.Timeout }}
    exec: {{ .TestCase.Timeout }}
  steps:
  - name: Update Root Resource
    description: |
      Update the root resource by using the specified update-parameter in annotation.
      Before updating the resources, the status conditions are cleaned.
    try:
    {{- range $resource := .Resources }}
    {{- if eq $resource.KindGroup "secret." -}}
      {{continue}}
    {{- end }}
    {{- if $resource.Root }}
    - script:
        content: |
          retry_kubectl() {
            local max_attempts=10
            local delay=5
            local attempt=1
            local cmd="$1"

            while [ $attempt -le $max_attempts ]; do
              echo "Kubectl attempt $attempt/$max_attempts for: $cmd"
              if eval "$cmd"; then
                echo "Kubectl operation successful on attempt $attempt"
                return 0
              else
                echo "Kubectl operation failed on attempt $attempt"
                if [ $attempt -lt $max_attempts ]; then
                  echo "Retrying in ${delay}s..."
                  sleep $delay
                fi
                ((attempt++))
              fi
            done
            echo "Kubectl operation failed after $max_attempts attempts"
            return 1
          }
          retry_kubectl "${KUBECTL} --subresource=status patch {{ $resource.KindGroup }}/{{ $resource.Name }} --type=merge -p '{\"status\":{\"conditions\":[]}}'"
          retry_kubectl "${KUBECTL} patch {{ $resource.KindGroup }}/{{ $resource.Name }} --type=merge -p '{\"spec\":{\"forProvider\":{{ $resource.UpdateParameter }}}}'"
    {{- end }}
    {{- end }}
  - name: Assert Updated Resource
    description: |
      Assert update operation. Firstly check the status conditions. Then assert
      the updated field in status.atProvider.
    {{- range $resource := .Resources }}
    {{- if eq $resource.KindGroup "secret." -}}
      {{continue}}
    {{- end }}
    {{- if $resource.Root }}
    try:
    - assert:
        resource:
          apiVersion: {{ $resource.APIVersion }}
          kind: {{ $resource.Kind }}
          metadata:
            name: {{ $resource.Name }}
            {{- if $resource.Namespace }}
            namespace: {{ $resource.Namespace }}
            {{- end }}
          status:
            {{- range $condition := $resource.Conditions }}
            ((conditions[?type == '{{ $condition }}'])[0]):
              status: "True"
            {{- end }}
    - script:
        content: ${KUBECTL} get {{ if $resource.Namespace }}--namespace {{ $resource.Namespace }} {{ end }} {{ $resource.KindGroup }}/{{ $resource.Name }} -o=jsonpath='{.status.atProvider{{ $resource.UpdateAssertKey }}}' | grep -q "^{{ $resource.UpdateAssertValue }}$"
    {{- end }}
    {{- end }}
